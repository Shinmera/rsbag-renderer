<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8"/>
    <title>Renderer</title>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  </head>
  <body>
    <header>
      <h1>Renderer</h1>
      <nav>
        <a href="select.html" title="Home"><i class="fa fa-home"></i></a>
        <a href="admin.html" title="Administration"><i class="fa fa-wrench"></i></a>
        <a href="/api/shutdown" title="Shut down"><i class="fa fa-power-off"></i></a>
      </nav>
    </header>
    <main class="renderer">
      <section class="player bag component" data-frames="10000" data-resolution="200">
        <nav class="controls">
          <a class="play"><i class="fa fa-play fa-fw"></i></a>
          <div class="seeker">
            <div class="loaded"></div>
            <div class="current"></div>
          </div>
          <span class="frameinfo">00:00:000</span>
        </nav>
        <section class="visualizations">
        </section>
      </section>
    </main>
    <footer>
      Footertext
    </footer>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
    <script type="text/javascript" src="OrbitControls.js"></script>
    <script type="text/javascript" src="Renderer.js"></script>
    <script type="text/javascript">
      var renderer = null;

      $(function(){
          function urlParameter(name) {
              return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
          }

          // Manual loading by static resource addresses for now.
          // this will be replaced by a single API call afterwards.
          var visualizerData = {};
          function insertData(name, type, data){
              var obj = visualizerData[name];
              obj[type] = data;
              
              if(obj.js && obj.html && obj.css){
                  renderer.loadVisualizer(obj.js,obj.html,obj.css);
              }
          }
          
          function loadVisualizerPart(name, type){
              jQuery.ajax({url: "visualizer/"+name+"."+type, dataType: "text"}).success(function(data){
                  insertData(name, type, data);
              }).fail(function(xhr, status){
                  console.log("Failure to load ",type,"of",name,":",status);
              });
          }

          function loadVisualizer(name){
              console.log("Loading visualizer",name);
              visualizerData[name] = {};
              loadVisualizerPart(name, "js");
              loadVisualizerPart(name, "html");
              loadVisualizerPart(name, "css");
          }

          // Same goes for this.
          function loadSource(name){
              console.log("Loading source",name);
              jQuery.ajax({url: "/source/"+name+".json", dataType: "json"}).success(function(data){
                  renderer.addFrameData(data);
                  console.log("Loaded source",name);
              }).fail(function(xhr, status){
                  console.log("Failure to load source",name,":",status);
              });
          }
          
          renderer = new Renderer($(".player").first());
          
          loadVisualizer(urlParameter("visualizer"));
          loadSource(urlParameter("source"));
      })
    </script>
  </body>
</html>
